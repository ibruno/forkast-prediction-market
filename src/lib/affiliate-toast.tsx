import { HandCoinsIcon } from 'lucide-react'
import { toast } from 'sonner'

const AFFILIATE_TOAST_COOLDOWN_MS = 12_000
let lastAffiliateToastAt = 0

type AffiliateToastContext = 'link' | 'embed'

function formatSharePercent(value: number) {
  const fixed = value.toFixed(2)
  return fixed.replace(/\.?0+$/, '')
}

interface AffiliateToastOptions {
  affiliateCode: string
  affiliateSharePercent: number | null
  tradeFeePercent: number | null
  siteName: string
  context?: AffiliateToastContext
}

export function maybeShowAffiliateToast({
  affiliateCode,
  affiliateSharePercent,
  tradeFeePercent,
  siteName,
  context = 'link',
}: AffiliateToastOptions) {
  if (!affiliateCode || !affiliateSharePercent || !tradeFeePercent) {
    return
  }

  const now = Date.now()
  if (now - lastAffiliateToastAt < AFFILIATE_TOAST_COOLDOWN_MS) {
    return
  }
  lastAffiliateToastAt = now

  const percentLabel = `${formatSharePercent(affiliateSharePercent)}%`
  const description = context === 'embed'
    ? `Embed this market on your site. Earn ${percentLabel} of the trading fees from users who sign up through your embed.`
    : `Invite friends to ${siteName}. Earn ${percentLabel} of the trading fees generated by users who sign up through your link.`
  const title = context === 'embed' ? 'Embed & earn' : 'Share & earn'

  toast(title, {
    description,
    icon: (
      <span className="flex size-7 items-center justify-center text-yes">
        <HandCoinsIcon className="size-6" />
      </span>
    ),
  })
}
